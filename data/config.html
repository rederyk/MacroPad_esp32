<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MacroPad Control Center</title>
    <link
      rel="icon"
      href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9IiMwZTYzOWMiLz48dGV4dCB4PSI1MCUiIHk9IjU1JSIgZm9udC1zaXplPSIzMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI2ZmZmZmZiIgZm9udC1mYW1pbHk9IlNlZ29lIFVJLCBBcmlhbCwgc2Fucy1zZXJpZiI+TTwvdGV4dD48L3N2Zz4K"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.css"
    />
    <link rel="stylesheet" href="/ui/app.css" />
  </head>
  <body>
    <div class="app-container">
      <header class="app-header">
        <div class="branding">
          <i class="fas fa-microchip"></i>
          <span>MacroPad Control Center</span>
        </div>
        <div class="header-status">
          <div class="status-chip">
            <i class="fas fa-wifi"></i>
            <span>Status:</span>
            <span id="wifi_status"></span>
          </div>
          <div class="status-chip">
            <i class="fas fa-broadcast-tower"></i>
            <span>AP:</span>
            <span id="ap_ip"></span>
          </div>
          <div class="status-chip">
            <i class="fas fa-network-wired"></i>
            <span>STA:</span>
            <span id="sta_ip"></span>
          </div>
        </div>
      </header>

      <nav class="tab-nav">
        <button class="tab-button active" data-target="panel-overview">
          <i class="fas fa-sliders-h"></i>
          Configurazione Rapida
        </button>
        <button class="tab-button" data-target="panel-data">
          <i class="fas fa-database"></i>
          Data Explorer
        </button>
        <button class="tab-button" data-target="panel-combos">
          <i class="fas fa-code"></i>
          Gestione Combo
        </button>
        <button class="tab-button" data-target="panel-wizard">
          <i class="fas fa-magic"></i>
          Impostazione Guidata Wi-Fi
        </button>
      </nav>

      <main>
        <section class="panel active" id="panel-overview">
          <div class="panel-grid">
            <div class="card">
              <div class="panel-heading">
                <h2 class="card-title">
                  <i class="fas fa-wifi me-2"></i>Impostazioni Wi-Fi
                </h2>
                <button class="secondary-btn" id="fillWizardFromForm">
                  <i class="fas fa-bolt"></i> Usa nel wizard
                </button>
              </div>
              <form id="wifiForm">
                <div class="form-group">
                  <label for="ap_ssid">Access Point SSID</label>
                  <input type="text" id="ap_ssid" autocomplete="off" />
                </div>
                <div class="form-group">
                  <label for="ap_password">Access Point Password</label>
                  <input type="password" id="ap_password" autocomplete="off" />
                </div>
                <div class="form-group">
                  <label for="router_ssid">Router SSID</label>
                  <input type="text" id="router_ssid" autocomplete="off" />
                </div>
                <div class="form-group">
                  <label for="router_password">Router Password</label>
                  <input
                    type="password"
                    id="router_password"
                    autocomplete="off"
                  />
                </div>
                <div class="d-flex gap-2 flex-wrap mt-2">
                  <button type="submit" class="primary-btn">
                    <i class="fas fa-save"></i> Salva configurazione e riavvia
                  </button>
                  <button type="button" class="secondary-btn" id="resetWifiForm">
                    <i class="fas fa-undo"></i> Ripristina
                  </button>
                </div>
              </form>
              <div class="form-status" id="wifiFormStatus"></div>
            </div>

            <div class="card">
              <h2 class="card-title">
                <i class="fas fa-info-circle me-2"></i>Stato e Azioni Rapide
              </h2>
              <div class="status-list">
                <span>
                  <i class="fas fa-signal me-2"></i>Modalità Corrente:
                  <strong id="wifiModeLabel">-</strong>
                </span>
                <span>
                  <i class="fas fa-circle-notch me-2"></i>Ultimo aggiornamento:
                  <strong id="wifiUpdatedLabel">Mai</strong>
                </span>
              </div>
              <div class="quick-actions">
                <button class="secondary-btn" id="refreshWifiData">
                  <i class="fas fa-sync-alt"></i>Aggiorna dallo sp device
                </button>
                <button class="secondary-btn" id="openDataExplorer">
                  <i class="fas fa-database"></i>Apri Data Explorer
                </button>
                <a class="secondary-btn" href="/advanced.html">
                  <i class="fas fa-terminal"></i> Configurazione avanzata
                </a>
                <a class="secondary-btn" href="/special_actions.html">
                  <i class="fas fa-bolt"></i> Azioni speciali
                </a>
              </div>
            </div>
          </div>
        </section>

        <section class="panel" id="panel-data">
          <div class="panel-heading data-panel-heading">
            <div>
              <h2 class="card-title">
                <i class="fas fa-database me-2"></i>Data Explorer
              </h2>
              <p class="panel-subtitle">
                Visualizza e scarica gli snapshot di <code>config.json</code> e
                <code>ir_data.json</code>.
              </p>
            </div>
            <div class="panel-actions">
              <button class="secondary-btn" id="refreshAllData">
                <i class="fas fa-sync-alt"></i>Aggiorna dati
              </button>
            </div>
          </div>

          <div class="data-columns">
            <div class="data-column">
              <article class="card data-card">
                <header class="card-header">
                  <div>
                    <h3 class="card-title">
                      <i class="fas fa-sliders-h me-2"></i>config.json
                    </h3>
                    <p class="card-subtitle">
                      Stato corrente della configurazione persistente.
                    </p>
                  </div>
                  <div class="card-actions">
                    <button class="secondary-btn icon-only" id="refreshConfigData" title="Ricarica config.json">
                      <i class="fas fa-sync"></i>
                    </button>
                  </div>
                </header>
                <div class="data-meta">
                  <span>
                    Aggiornato: <strong id="configDataUpdated">Mai</strong>
                  </span>
                  <span>
                    Sezioni: <strong id="configDataCount">0</strong>
                  </span>
                </div>
                <div class="kv-collection" id="configDataSummary"></div>
              </article>

              <article class="card data-card">
                <header class="card-header">
                  <div>
                    <h3 class="card-title">
                      <i class="fas fa-code me-2"></i>config.json (raw)
                    </h3>
                    <p class="card-subtitle">
                      JSON formattato per esportazione o copia.
                    </p>
                  </div>
                  <div class="card-actions">
                    <button class="secondary-btn" id="copyConfigJson">
                      <i class="fas fa-copy"></i>Copia
                    </button>
                    <button class="secondary-btn" id="downloadConfigJson">
                      <i class="fas fa-download"></i>Scarica
                    </button>
                  </div>
                </header>
                <pre class="json-block" id="configJsonRaw">{}</pre>
              </article>
            </div>

            <div class="data-column">
              <article class="card data-card">
                <header class="card-header">
                  <div>
                    <h3 class="card-title">
                      <i class="fas fa-remote me-2"></i>ir_data.json
                    </h3>
                    <p class="card-subtitle">
                      Database dei comandi IR registrati.
                    </p>
                  </div>
                  <div class="card-actions">
                    <button class="secondary-btn icon-only" id="refreshIrData" title="Ricarica ir_data.json">
                      <i class="fas fa-sync"></i>
                    </button>
                  </div>
                </header>
                <div class="data-meta">
                  <span>
                    Aggiornato: <strong id="irDataUpdated">Mai</strong>
                  </span>
                  <span>
                    Dispositivi: <strong id="irDeviceCount">0</strong>
                  </span>
                </div>
                <div class="kv-collection" id="irDataSummary"></div>
              </article>

              <article class="card data-card">
                <header class="card-header">
                  <div>
                    <h3 class="card-title">
                      <i class="fas fa-code me-2"></i>ir_data.json (raw)
                    </h3>
                    <p class="card-subtitle">
                      JSON completo pronto per esportazione.
                    </p>
                  </div>
                  <div class="card-actions">
                    <button class="secondary-btn" id="copyIrJson">
                      <i class="fas fa-copy"></i>Copia
                    </button>
                    <button class="secondary-btn" id="downloadIrJson">
                      <i class="fas fa-download"></i>Scarica
                    </button>
                  </div>
                </header>
                <pre class="json-block" id="irJsonRaw">{}</pre>
              </article>
            </div>
          </div>
        </section>

        <section class="panel" id="panel-combos">
          <div class="combo-shell">
            <div class="panel-heading">
              <h2 class="card-title">
                <i class="fas fa-layer-group me-2"></i>Editor combo multiset
              </h2>
              <button class="secondary-btn" id="reloadCombos">
                <i class="fas fa-sync-alt"></i> Ricarica
              </button>
            </div>

            <div class="combo-tab-bar" id="comboTabBar"></div>

            <div class="ide-toolbar">
              <button class="primary-btn" id="comboSaveButton">
                <i class="fas fa-save"></i> Salva file
              </button>
              <button class="secondary-btn" id="comboFormatButton">
                <i class="fas fa-align-left"></i> Format
              </button>
            </div>

            <textarea id="comboEditor"></textarea>

            <div class="status-bar">
              <div id="comboStatus">Pronto</div>
              <div class="status-right">
                <span id="comboCursor">Ln 1, Col 1</span>
                <span id="comboFormatIndicator">JSON</span>
                <span id="comboErrorIndicator">0 errori</span>
              </div>
            </div>

            <div class="logs-container">
              <div class="logs-header">
                <h5>Logs dispositivo</h5>
                <div class="d-flex gap-2">
                  <button class="secondary-btn" id="comboReconnectLog">
                    <i class="fas fa-sync-alt"></i> Riconnetti
                  </button>
                  <button class="secondary-btn" id="comboClearLog">
                    <i class="fas fa-broom"></i> Pulisci
                  </button>
                </div>
              </div>
              <div id="comboLogContainer"></div>
            </div>
          </div>
        </section>

        <section class="panel" id="panel-wizard">
          <div class="card wizard-shell">
            <div class="panel-heading">
              <h2 class="card-title">
                <i class="fas fa-magic me-2"></i>Impostazione guidata Wi-Fi
              </h2>
              <button class="secondary-btn" id="wizardResetButton">
                <i class="fas fa-undo"></i> Ricomincia
              </button>
            </div>

            <div class="wizard-progress">
              <div class="step active" data-step="1">1. Modalità</div>
              <div class="step" data-step="2">2. Credenziali</div>
              <div class="step" data-step="3">3. Riepilogo</div>
            </div>

            <div class="wizard-content">
              <div class="wizard-step active" data-step="1">
                <p>
                  Scegli il tipo di connessione da configurare. È sempre
                  consigliato mantenere l'Access Point attivo per recupero
                  rapido.
                </p>
                <div class="wizard-options">
                  <label class="wizard-option active" data-mode="dual">
                    <input
                      type="radio"
                      name="wizard_mode"
                      value="dual"
                      checked
                    />
                    <div>
                      <strong>Access Point + Router</strong>
                      <p class="mb-0 text-secondary">
                        L'ESP32 crea un proprio AP e si collega anche al router
                        di casa.
                      </p>
                    </div>
                  </label>
                  <label class="wizard-option" data-mode="ap-only">
                    <input type="radio" name="wizard_mode" value="ap-only" />
                    <div>
                      <strong>Solo Access Point</strong>
                      <p class="mb-0 text-secondary">
                        L'ESP32 resta isolato e crea solo la propria rete.
                      </p>
                    </div>
                  </label>
                </div>
              </div>

              <div class="wizard-step" data-step="2">
                <p>
                  Inserisci le credenziali desiderate. Se scegli solo AP, i
                  campi router saranno ignorati.
                </p>
                <div class="form-group">
                  <label for="wizard_ap_ssid">Access Point SSID</label>
                  <input type="text" id="wizard_ap_ssid" autocomplete="off" />
                </div>
                <div class="form-group">
                  <label for="wizard_ap_password">Access Point Password</label>
                  <input
                    type="password"
                    id="wizard_ap_password"
                    autocomplete="off"
                  />
                </div>
                <div class="form-group wizard-router-fields">
                  <label for="wizard_router_ssid">Router SSID</label>
                  <input
                    type="text"
                    id="wizard_router_ssid"
                    autocomplete="off"
                  />
                </div>
                <div class="form-group wizard-router-fields">
                  <label for="wizard_router_password">Router Password</label>
                  <input
                    type="password"
                    id="wizard_router_password"
                    autocomplete="off"
                  />
                </div>
              </div>

              <div class="wizard-step" data-step="3">
                <p>Controlla il riepilogo prima di applicare le modifiche.</p>
                <div class="summary-card">
                  <ul id="wizardSummary"></ul>
                </div>
              </div>
            </div>

            <div class="wizard-footer">
              <div class="form-status" id="wizardStatus"></div>
              <div class="actions">
                <button class="secondary-btn" id="wizardBackButton">
                  <i class="fas fa-arrow-left"></i> Indietro
                </button>
                <button class="primary-btn" id="wizardNextButton">
                  Avanti <i class="fas fa-arrow-right"></i>
                </button>
                <button class="primary-btn d-none" id="wizardFinishButton">
                  <i class="fas fa-check"></i> Applica configurazione
                </button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/lint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/lint/json-lint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/closebrackets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/matchbrackets.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/selection/active-line.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonlint/1.6.0/jsonlint.min.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>

    <script>
      const state = {
        wifi: {
          original: {},
          lastUpdated: null,
        },
        data: {
          config: {},
          configUpdated: null,
          ir: {},
          irUpdated: null,
          rawConfig: "{}",
          rawIr: "{}",
        },
        combos: {
          files: [],
          currentIndex: 0,
          editor: null,
          errorCount: 0,
          eventSource: null,
        },
        wizard: {
          step: 1,
          mode: "dual",
          data: {
            ap_ssid: "",
            ap_password: "",
            router_ssid: "",
            router_password: "",
          },
        },
      };

      const toast = document.getElementById("toast");
      const hasPrettier =
        typeof window.prettier !== "undefined" &&
        Array.isArray(window.prettierPlugins) &&
        window.prettierPlugins.length > 0;
      const prettierPlugins = hasPrettier ? window.prettierPlugins : [];
      const supportsCodeMirror = typeof window.CodeMirror !== "undefined";
      const statusElements = {
        wifi: document.getElementById("wifi_status"),
        ap: document.getElementById("ap_ip"),
        sta: document.getElementById("sta_ip"),
        mode: document.getElementById("wifiModeLabel"),
        updated: document.getElementById("wifiUpdatedLabel"),
      };
      const comboTypeLabels = {
        common: "Sistema",
        combo: "Dispositivo",
        custom: "Personale / Sessione",
        legacy: "Legacy",
        unknown: "Altro",
      };
      const comboTypeOrder = {
        common: 0,
        combo: 1,
        custom: 2,
        legacy: 3,
        unknown: 4,
      };

      function formatJsonValue(value, options = {}) {
        const { silent = false } = options;
        try {
          const stringValue =
            typeof value === "string" ? value : JSON.stringify(value);

          if (hasPrettier) {
            return window.prettier.format(stringValue, {
              parser: "json",
              plugins: prettierPlugins,
              tabWidth: 2,
              useTabs: false,
            });
          }

          const parsed =
            typeof value === "string" ? JSON.parse(stringValue) : value;

          return JSON.stringify(parsed, null, 2);
        } catch (error) {
          if (silent) {
            console.warn("Unable to format JSON value", error);
            if (typeof value === "string") {
              return value;
            }
            try {
              return JSON.stringify(value, null, 2);
            } catch (_) {
              return "";
            }
          }
          throw error;
        }
      }

      function showToast(message, type = "info") {
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => {
          toast.className = "toast";
        }, 3200);
      }

      function switchPanel(panelId) {
        document.querySelectorAll(".panel").forEach((panel) => {
          panel.classList.toggle("active", panel.id === panelId);
        });
      }

      function activateTab(panelId) {
        document.querySelectorAll(".tab-button").forEach((btn) => {
          const target = btn.getAttribute("data-target");
          btn.classList.toggle("active", target === panelId);
        });
        switchPanel(panelId);
      }

      function setupTabs() {
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.addEventListener("click", () =>
            activateTab(btn.getAttribute("data-target"))
          );
        });
      }

      function escapeHtml(value) {
        if (value === null || value === undefined) {
          return "";
        }
        return String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function describeValueType(value) {
        if (Array.isArray(value)) {
          return `Array (${value.length})`;
        }
        if (value === null) {
          return "Null";
        }
        if (typeof value === "object") {
          return `Object (${Object.keys(value).length})`;
        }
        return typeof value;
      }

      function renderPrimitive(value) {
        if (value === null) {
          return '<span class="kv-primitive">null</span>';
        }
        switch (typeof value) {
          case "boolean":
            return `<span class="kv-primitive">${value ? "true" : "false"}</span>`;
          case "number":
            return `<span class="kv-number">${value}</span>`;
          case "string":
            return `<span class="kv-string">"${escapeHtml(value)}"</span>`;
          default:
            return `<span class="kv-primitive">${escapeHtml(String(value))}</span>`;
        }
      }

      function renderArrayValue(arr, depth = 0) {
        if (!Array.isArray(arr) || arr.length === 0) {
          return '<span class="kv-primitive">[]</span>';
        }
        if (depth >= 2) {
          return `<span class="kv-summary">Array(${arr.length})</span>`;
        }
        const rows = arr
          .map(
            (item, index) => `
              <div class="kv-row depth-${depth + 1}">
                <span class="kv-key">[${index}]</span>
                <span class="kv-value">${renderValue(item, depth + 1)}</span>
              </div>
            `
          )
          .join("");

        if (depth === 0) {
          return `<div class="kv-children">${rows}</div>`;
        }

        return `
          <details class="kv-details"${depth === 1 ? " open" : ""}>
            <summary>Array (${arr.length})</summary>
            <div class="kv-children">${rows}</div>
          </details>
        `;
      }

      function renderObjectValue(obj, depth = 0) {
        if (obj === null || typeof obj !== "object") {
          return renderPrimitive(obj);
        }
        const keys = Object.keys(obj);
        if (keys.length === 0) {
          return '<span class="kv-primitive">{}</span>';
        }
        if (depth >= 2) {
          return `<span class="kv-summary">Object(${keys.length})</span>`;
        }

        const rows = keys
          .map(
            (key) => `
              <div class="kv-row depth-${depth + 1}">
                <span class="kv-key">${escapeHtml(key)}</span>
                <span class="kv-value">${renderValue(obj[key], depth + 1)}</span>
              </div>
            `
          )
          .join("");

        if (depth === 0) {
          return `<div class="kv-children">${rows}</div>`;
        }

        return `
          <details class="kv-details"${depth === 1 ? " open" : ""}>
            <summary>Object (${keys.length})</summary>
            <div class="kv-children">${rows}</div>
          </details>
        `;
      }

      function renderValue(value, depth = 0) {
        if (value === null || typeof value !== "object") {
          return renderPrimitive(value);
        }
        if (Array.isArray(value)) {
          return renderArrayValue(value, depth);
        }
        return renderObjectValue(value, depth);
      }

      function renderConfigDataExplorer() {
        const container = document.getElementById("configDataSummary");
        if (!container) {
          return;
        }
        const data = state.data.config || {};
        const entries = Object.entries(data);
        document.getElementById("configDataCount").textContent = entries.length;

        if (entries.length === 0) {
          container.innerHTML =
            '<div class="empty-state">Nessuna sezione disponibile. Premi "Aggiorna dati".</div>';
          return;
        }

        container.innerHTML = entries
          .map(
            ([key, value]) => `
              <article class="kv-group">
                <header class="kv-group-header">
                  <span class="kv-group-title">${escapeHtml(key)}</span>
                  <span class="kv-group-meta">${describeValueType(value)}</span>
                </header>
                <div class="kv-group-body">
                  ${renderValue(value, 0)}
                </div>
              </article>
            `
          )
          .join("");
      }

      function renderIrCommand(name, payload) {
        const badges = [];
        if (payload && payload.protocol) {
          badges.push(
            `<span class="chip chip-accent">${escapeHtml(payload.protocol)}</span>`
          );
        }
        if (payload && typeof payload.bits === "number") {
          badges.push(`<span class="chip">${payload.bits} bit</span>`);
        }
        if (payload && payload.value !== undefined) {
          badges.push(
            `<code class="chip chip-code">${escapeHtml(payload.value)}</code>`
          );
        }

        const meta = [];
        if (payload && payload.address !== undefined) {
          meta.push(`Addr ${escapeHtml(payload.address)}`);
        }
        if (payload && payload.command !== undefined) {
          meta.push(`Cmd ${escapeHtml(payload.command)}`);
        }
        if (payload && Array.isArray(payload.raw)) {
          meta.push(`RAW x${payload.raw.length}`);
        }

        const detail =
          payload && typeof payload === "object"
            ? renderValue(payload, 1)
            : "";

        return `
          <div class="kv-group-item">
            <div class="kv-row depth-1">
              <span class="kv-key">${escapeHtml(name)}</span>
              <span class="kv-value">${
                badges.length > 0 ? badges.join(" ") : "-"
              }</span>
            </div>
            ${
              meta.length > 0
                ? `<div class="kv-meta">${meta.join(" · ")}</div>`
                : ""
            }
            ${
              detail
                ? `<div class="kv-details-wrapper">${detail}</div>`
                : ""
            }
          </div>
        `;
      }

      function renderIrDataExplorer() {
        const container = document.getElementById("irDataSummary");
        if (!container) {
          return;
        }
        const devices = state.data.ir || {};
        const entries = Object.entries(devices);
        document.getElementById("irDeviceCount").textContent = entries.length;

        if (entries.length === 0) {
          container.innerHTML =
            '<div class="empty-state">Nessun dispositivo IR registrato.</div>';
          return;
        }

        container.innerHTML = entries
          .map(([device, commands]) => {
            const commandEntries = Object.entries(commands || {});
            const body =
              commandEntries.length === 0
                ? '<div class="empty-state nested">Nessun comando per questo dispositivo.</div>'
                : commandEntries
                    .map(([name, payload]) => renderIrCommand(name, payload))
                    .join("");
            return `
              <article class="kv-group">
                <header class="kv-group-header">
                  <span class="kv-group-title">${escapeHtml(device)}</span>
                  <span class="kv-group-meta">
                    ${commandEntries.length} comando${
              commandEntries.length === 1 ? "" : "i"
            }
                  </span>
                </header>
                <div class="kv-group-body">
                  ${body}
                </div>
              </article>
            `;
          })
          .join("");
      }

      function formatTimestamp(date) {
        if (!date) {
          return "Mai";
        }
        try {
          return date.toLocaleString();
        } catch (error) {
          return date.toString();
        }
      }

      function updateDataMetaLabels() {
        const configLabel = document.getElementById("configDataUpdated");
        if (configLabel) {
          configLabel.textContent = formatTimestamp(state.data.configUpdated);
        }
        const irLabel = document.getElementById("irDataUpdated");
        if (irLabel) {
          irLabel.textContent = formatTimestamp(state.data.irUpdated);
        }
      }

      function updateRawJsonBlocks() {
        const configRawEl = document.getElementById("configJsonRaw");
        if (configRawEl) {
          configRawEl.textContent = state.data.rawConfig || "{}";
        }
        const irRawEl = document.getElementById("irJsonRaw");
        if (irRawEl) {
          irRawEl.textContent = state.data.rawIr || "{}";
        }
      }

      async function copyToClipboard(value, successMessage) {
        if (!value) {
          showToast("Nessun contenuto da copiare.", "error");
          return;
        }
        try {
          await navigator.clipboard.writeText(value);
          showToast(successMessage || "Contenuto copiato negli appunti.", "success");
        } catch (error) {
          console.error("Clipboard error:", error);
          showToast("Impossibile copiare negli appunti.", "error");
        }
      }

      function downloadJson(filename, content) {
        try {
          const blob = new Blob([content], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const anchor = document.createElement("a");
          anchor.href = url;
          anchor.download = filename;
          document.body.appendChild(anchor);
          anchor.click();
          document.body.removeChild(anchor);
          URL.revokeObjectURL(url);
          showToast(`${filename} scaricato.`, "success");
        } catch (error) {
          console.error("Download error:", error);
          showToast(`Impossibile scaricare ${filename}.`, "error");
        }
      }

      function applyDeviceStatus(status) {
        if (!status) {
          return;
        }
        if (statusElements.wifi) statusElements.wifi.textContent = status.wifi_status || "-";
        if (statusElements.ap) statusElements.ap.textContent = status.ap_ip || "-";
        if (statusElements.sta) statusElements.sta.textContent = status.sta_ip || "-";
      }

      async function refreshDeviceStatus(showNotification = false) {
        try {
          const response = await fetch("/status.json", { cache: "no-cache" });
          if (!response.ok) throw new Error("Impossibile recuperare status.json");
          const status = await response.json();
          applyDeviceStatus(status);
          if (showNotification) {
            showToast("Stato dispositivo aggiornato.", "success");
          }
        } catch (error) {
          console.error("Errore durante l'aggiornamento dello stato:", error);
          if (showNotification) {
            showToast("Errore durante l'aggiornamento dello stato.", "error");
          }
        }
      }

      function prettifyComboFileLabel(name, type) {
        if (name === "combo_common.json") {
          return "combo_common.json (Shared)";
        }
        if (name === "combo.json") {
          return "combo.json (Legacy multi-set)";
        }
        if (name === "combinations.json") {
          return "combinations.json (Legacy config)";
        }
        if (type === "combo") {
          const match = name.match(/combo_(\d+)\.json/);
          if (match) {
            return `combo_${match[1]}.json`;
          }
        }
        if (type === "custom") {
          const match = name.match(/my_combo_(\d+)\.json/);
          if (match) {
            return `my_combo_${match[1]}.json`;
          }
        }
        return name;
      }

      function getCurrentComboFile() {
        return state.combos.files[state.combos.currentIndex] || null;
      }

      async function loadWifiConfig(showNotification = false) {
        const statusEl = document.getElementById("wifiFormStatus");
        statusEl.textContent = "Caricamento configurazione...";
        try {
          const response = await fetch("/config.json");
          if (!response.ok) throw new Error("Impossibile recuperare config.json");

          const config = await response.json();
          state.wifi.original = config;
          state.data.config = config || {};
          try {
            state.data.rawConfig = formatJsonValue(config || {}, { silent: true });
          } catch (error) {
            console.warn("Impossibile formattare config.json:", error);
            state.data.rawConfig = JSON.stringify(config || {});
          }
          const wifi = (config && config.wifi) || {};
          document.getElementById("ap_ssid").value = wifi.ap_ssid || "";
          document.getElementById("ap_password").value =
            wifi.ap_password || "";
          document.getElementById("router_ssid").value =
            wifi.router_ssid || "";
          document.getElementById("router_password").value =
            wifi.router_password || "";

          hydrateWizardFromWifi(wifi);
          updateWifiModeLabel(wifi);
          const now = new Date();
          state.wifi.lastUpdated = now;
          state.data.configUpdated = now;
          updateWifiUpdatedLabel();
          renderConfigDataExplorer();
          updateDataMetaLabels();
          updateRawJsonBlocks();
          statusEl.textContent = "Configurazione caricata dal dispositivo.";
          if (showNotification) {
            showToast("Configurazione Wi-Fi aggiornata.", "success");
          }
        } catch (error) {
          console.error(error);
          statusEl.textContent = "Errore nel caricamento della configurazione.";
          showToast("Errore nel recupero della configurazione Wi-Fi.", "error");
        }
      }

      async function loadIrData(showNotification = false) {
        const container = document.getElementById("irDataSummary");
        if (container && !showNotification) {
          container.innerHTML =
            '<div class="loading-state">Caricamento dati IR...</div>';
        }
        try {
          const response = await fetch("/ir_data.json", { cache: "no-cache" });
          if (!response.ok) {
            throw new Error("Impossibile recuperare ir_data.json");
          }

          const irPayload = await response.json();
          const devices = (irPayload && irPayload.devices) || {};
          state.data.ir = devices;
          try {
            state.data.rawIr = formatJsonValue(irPayload || {}, { silent: true });
          } catch (error) {
            console.warn("Impossibile formattare ir_data.json:", error);
            state.data.rawIr = JSON.stringify(irPayload || {});
          }
          state.data.irUpdated = new Date();

          renderIrDataExplorer();
          updateDataMetaLabels();
          updateRawJsonBlocks();
          if (showNotification) {
            showToast("Dati IR aggiornati.", "success");
          }
        } catch (error) {
          console.error(error);
          if (container) {
            container.innerHTML =
              '<div class="empty-state error">Errore nel caricamento di ir_data.json.</div>';
          }
          if (showNotification) {
            showToast("Errore nel recupero di ir_data.json.", "error");
          }
        }
      }

      function updateWifiModeLabel(wifi) {
        const label = document.getElementById("wifiModeLabel");
        const hasRouter =
          wifi && wifi.router_ssid && wifi.router_ssid.trim().length > 0;
        label.textContent = hasRouter
          ? "AP + Router (dual mode)"
          : "Solo Access Point";
      }

      function updateWifiUpdatedLabel() {
        const label = document.getElementById("wifiUpdatedLabel");
        if (!state.wifi.lastUpdated) {
          label.textContent = "Mai";
          return;
        }
        label.textContent = state.wifi.lastUpdated.toLocaleString();
      }

      async function submitWifiConfig(payload, statusEl) {
        statusEl.textContent = "Salvataggio in corso...";
        try {
          const response = await fetch("/config.json", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const text = await response.text();
          statusEl.textContent = text || "Configurazione salvata.";
          showToast("Configurazione salvata. Il dispositivo si riavvierà.", "success");
        } catch (error) {
          console.error(error);
          statusEl.textContent = "Errore durante il salvataggio.";
          showToast("Errore durante il salvataggio della configurazione.", "error");
        }
      }

      function gatherWifiDataFromForm() {
        return {
          ap_ssid: document.getElementById("ap_ssid").value.trim(),
          ap_password: document.getElementById("ap_password").value,
          router_ssid: document.getElementById("router_ssid").value.trim(),
          router_password: document.getElementById("router_password").value,
        };
      }

      function hydrateWizardFromWifi(wifi) {
        const payload = {
          ap_ssid: wifi.ap_ssid || "",
          ap_password: wifi.ap_password || "",
          router_ssid: wifi.router_ssid || "",
          router_password: wifi.router_password || "",
        };

        state.wizard.mode =
          payload.router_ssid && payload.router_ssid.length > 0
            ? "dual"
            : "ap-only";
        state.wizard.data = payload;
        updateWizardInputs();
        renderWizard();
      }

      function populateWizardSummary() {
        const summary = document.getElementById("wizardSummary");
        const data = state.wizard.data;
        const mode =
          state.wizard.mode === "dual"
            ? "Access Point + Router"
            : "Solo Access Point";
        summary.innerHTML = `
          <li><strong>Modalità:</strong> ${mode}</li>
          <li><strong>AP SSID:</strong> ${data.ap_ssid || "<em>non impostato</em>"}</li>
          <li><strong>AP Password:</strong> ${
            data.ap_password ? "••••••" : "<em>non impostata</em>"
          }</li>
          ${
            state.wizard.mode === "dual"
              ? `<li><strong>Router SSID:</strong> ${
                  data.router_ssid || "<em>non impostato</em>"
                }</li>
                 <li><strong>Router Password:</strong> ${
                   data.router_password ? "••••••" : "<em>non impostata</em>"
                 }</li>`
              : "<li><strong>Router:</strong> disabilitato</li>"
          }
        `;
      }

      function updateWizardInputs() {
        document
          .querySelectorAll(".wizard-option")
          .forEach((option) =>
            option.classList.toggle(
              "active",
              option.getAttribute("data-mode") === state.wizard.mode
            )
          );
        document
          .querySelectorAll('input[name="wizard_mode"]')
          .forEach((input) => {
            input.checked = input.value === state.wizard.mode;
          });

        document.getElementById("wizard_ap_ssid").value =
          state.wizard.data.ap_ssid || "";
        document.getElementById("wizard_ap_password").value =
          state.wizard.data.ap_password || "";
        document.getElementById("wizard_router_ssid").value =
          state.wizard.data.router_ssid || "";
        document.getElementById("wizard_router_password").value =
          state.wizard.data.router_password || "";

        document.querySelectorAll(".wizard-router-fields").forEach((el) => {
          el.style.display = state.wizard.mode === "dual" ? "flex" : "none";
        });
      }

      function renderWizard() {
        document.querySelectorAll(".wizard-step").forEach((step) => {
          step.classList.toggle(
            "active",
            parseInt(step.getAttribute("data-step"), 10) === state.wizard.step
          );
        });
        document.querySelectorAll(".wizard-progress .step").forEach((step) => {
          step.classList.toggle(
            "active",
            parseInt(step.getAttribute("data-step"), 10) === state.wizard.step
          );
        });

        document
          .getElementById("wizardBackButton")
          .classList.toggle("d-none", state.wizard.step === 1);

        document
          .getElementById("wizardNextButton")
          .classList.toggle("d-none", state.wizard.step === 3);

        document
          .getElementById("wizardFinishButton")
          .classList.toggle("d-none", state.wizard.step !== 3);

        if (state.wizard.step === 3) {
          populateWizardSummary();
        }
      }

      function resetWizard() {
        state.wizard.step = 1;
        state.wizard.mode = "dual";
        state.wizard.data = {
          ap_ssid: "",
          ap_password: "",
          router_ssid: "",
          router_password: "",
        };
        updateWizardInputs();
        renderWizard();
        document.getElementById("wizardStatus").textContent =
          "Wizard ripristinato.";
      }

      function wizardCollectStepData() {
        state.wizard.mode = document.querySelector(
          'input[name="wizard_mode"]:checked'
        ).value;
        state.wizard.data.ap_ssid = document
          .getElementById("wizard_ap_ssid")
          .value.trim();
        state.wizard.data.ap_password =
          document.getElementById("wizard_ap_password").value;
        state.wizard.data.router_ssid = document
          .getElementById("wizard_router_ssid")
          .value.trim();
        state.wizard.data.router_password =
          document.getElementById("wizard_router_password").value;

        if (state.wizard.mode !== "dual") {
          state.wizard.data.router_ssid = "";
          state.wizard.data.router_password = "";
        }
      }

      function setupWizard() {
        document.querySelectorAll(".wizard-option").forEach((option) => {
          option.addEventListener("click", () => {
            state.wizard.mode = option.getAttribute("data-mode");
            updateWizardInputs();
          });
        });

        document
          .getElementById("wizardNextButton")
          .addEventListener("click", () => {
            if (state.wizard.step === 1) {
              wizardCollectStepData();
              state.wizard.step = 2;
              renderWizard();
              return;
            }
            if (state.wizard.step === 2) {
              wizardCollectStepData();
              state.wizard.step = 3;
              renderWizard();
            }
          });

        document
          .getElementById("wizardBackButton")
          .addEventListener("click", () => {
            if (state.wizard.step > 1) {
              state.wizard.step -= 1;
              renderWizard();
            }
          });

        document
          .getElementById("wizardFinishButton")
          .addEventListener("click", async () => {
            wizardCollectStepData();
            document.getElementById("wizardStatus").textContent =
              "Invio configurazione...";
            const payload = {
              wifi: {
                ap_ssid: state.wizard.data.ap_ssid,
                ap_password: state.wizard.data.ap_password,
                router_ssid: state.wizard.data.router_ssid,
                router_password: state.wizard.data.router_password,
              },
            };
            await submitWifiConfig(
              payload,
              document.getElementById("wizardStatus")
            );
            state.wifi.lastUpdated = new Date();
            updateWifiUpdatedLabel();
            showToast(
              "Configurazione inviata. Il dispositivo potrebbe riavviarsi.",
              "success"
            );
          });

        document
          .getElementById("wizardResetButton")
          .addEventListener("click", resetWizard);
      }

      function resetWifiForm() {
        const wifi = state.wifi.original.wifi || {};
        document.getElementById("ap_ssid").value = wifi.ap_ssid || "";
        document.getElementById("ap_password").value = wifi.ap_password || "";
        document.getElementById("router_ssid").value =
          wifi.router_ssid || "";
        document.getElementById("router_password").value =
          wifi.router_password || "";
        document.getElementById("wifiFormStatus").textContent =
          "Valori ripristinati.";
      }

      function sendFormValuesToWizard() {
        const wifi = gatherWifiDataFromForm();
        hydrateWizardFromWifi(wifi);
        document.getElementById("wizardStatus").textContent =
          "Valori importati dal form.";
        showToast("Valori importati nel wizard.", "info");
      }

      /* Combo editor setup */
      function computePos(text, index) {
        const lines = text.slice(0, index).split("\n");
        const line = lines.length - 1;
        const ch = lines[lines.length - 1].length;
        return CodeMirror.Pos(line, ch);
      }

      if (supportsCodeMirror) {
        CodeMirror.registerHelper("lint", "json", function (text) {
          const found = [];
          try {
            jsonlint.parse(text);
            state.combos.errorCount = 0;
          } catch (e) {
            const match = e.message.match(/line (\d+) column (\d+)/);
            if (match) {
              const line = parseInt(match[1], 10) - 1;
              const ch = parseInt(match[2], 10) - 1;
              found.push({
                from: CodeMirror.Pos(line, ch),
                to: CodeMirror.Pos(line, ch + 1),
                message: e.message,
                severity: "error",
              });
            } else {
              found.push({
                from: CodeMirror.Pos(0, 0),
                to: CodeMirror.Pos(0, 1),
                message: e.message,
                severity: "error",
              });
            }
            state.combos.errorCount = 1;
          }

          const regex = /"([^"\\]*(?:\\.[^"\\]*)*)"\s*:/g;
          const keys = {};
          let m;
          while ((m = regex.exec(text)) !== null) {
            const key = m[1];
            if (keys[key]) {
              const pos = computePos(text, m.index);
              found.push({
                from: pos,
                to: CodeMirror.Pos(pos.line, pos.ch + key.length + 2),
                message: `Duplicate key: ${key}`,
                severity: "error",
              });
              state.combos.errorCount++;
            } else {
              keys[key] = true;
            }
          }

          updateComboErrorIndicator();
          return found;
        });
      } else {
        console.warn(
          "CodeMirror non disponibile: linting avanzato disabilitato."
        );
      }

      function updateComboErrorIndicator() {
        const el = document.getElementById("comboErrorIndicator");
        const count = state.combos.errorCount;
        if (count === 0) {
          el.textContent = "0 errori";
          el.style.color = "#d4ffd4";
        } else {
          el.textContent = `${count} errore${count > 1 ? "i" : ""}`;
          el.style.color = "#ffd4d4";
        }
      }

      function setupComboEditor() {
        const textarea = document.getElementById("comboEditor");

        if (supportsCodeMirror) {
          state.combos.editor = CodeMirror.fromTextArea(textarea, {
            mode: { name: "javascript", json: true },
            theme: "dracula",
            lineNumbers: true,
            tabSize: 2,
            indentWithTabs: false,
            autoCloseBrackets: true,
            matchBrackets: true,
            styleActiveLine: true,
            lint: true,
            gutters: ["CodeMirror-lint-markers"],
            extraKeys: {
              "Ctrl-S": () => saveCurrentComboFile(),
              "Cmd-S": () => saveCurrentComboFile(),
            },
          });

          state.combos.editor.on("cursorActivity", () => {
            const cursor = state.combos.editor.getCursor();
            document.getElementById(
              "comboCursor"
            ).textContent = `Ln ${cursor.line + 1}, Col ${cursor.ch + 1}`;
          });
        } else {
          console.warn(
            "Editor avanzato non disponibile, si utilizza la textarea di base."
          );
          textarea.classList.add("form-control");
          textarea.style.height = "calc(100vh - 340px)";
          state.combos.editor = {
            getValue: () => textarea.value,
            setValue: (val) => {
              textarea.value = val;
            },
            focus: () => textarea.focus(),
            on: () => {},
          };
          document.getElementById("comboCursor").textContent = "Plain textarea";
        }

        document.getElementById("comboFormatIndicator").textContent = hasPrettier
          ? "JSON (Prettier)"
          : "JSON";

        document
          .getElementById("comboSaveButton")
          .addEventListener("click", saveCurrentComboFile);
        document
          .getElementById("comboFormatButton")
          .addEventListener("click", formatComboEditor);
        document
          .getElementById("comboClearLog")
          .addEventListener(
            "click",
            () => (document.getElementById("comboLogContainer").innerHTML = "")
          );
        document
          .getElementById("comboReconnectLog")
          .addEventListener("click", () => {
            if (state.combos.eventSource) {
              state.combos.eventSource.close();
            }
            setupComboLogs();
          });
        document
          .getElementById("reloadCombos")
          .addEventListener("click", () => loadComboFiles(true));

        document.addEventListener("keydown", (event) => {
          if ((event.ctrlKey || event.metaKey) && event.key === "s") {
            event.preventDefault();
            saveCurrentComboFile();
          }
        });
      }

      function updateComboTabs() {
        const tabBar = document.getElementById("comboTabBar");
        tabBar.innerHTML = "";

        const grouped = {};
        state.combos.files.forEach((file, index) => {
          if (!grouped[file.type]) {
            grouped[file.type] = [];
          }
          grouped[file.type].push({ file, index });
        });

        const types = Object.keys(grouped).sort((a, b) => {
          const orderA = comboTypeOrder.hasOwnProperty(a)
            ? comboTypeOrder[a]
            : comboTypeOrder.unknown;
          const orderB = comboTypeOrder.hasOwnProperty(b)
            ? comboTypeOrder[b]
            : comboTypeOrder.unknown;
          if (orderA !== orderB) {
            return orderA - orderB;
          }
          const labelA = comboTypeLabels[a] || a;
          const labelB = comboTypeLabels[b] || b;
          return labelA.localeCompare(labelB);
        });

        types.forEach((type) => {
          const entries = grouped[type];
          if (!entries || entries.length === 0) {
            return;
          }
          const group = document.createElement("div");
          group.className = "combo-tab-group";

          const title = document.createElement("div");
          title.className = "combo-tab-group-title";
          title.textContent = comboTypeLabels[type] || type;
          group.appendChild(title);

          entries.forEach(({ file, index }) => {
            const tab = document.createElement("div");
            tab.className = "combo-tab";
            tab.dataset.index = index;
            tab.dataset.type = type;
            tab.textContent = file.label || file.name;
            tab.title = file.name;
            tab.addEventListener("click", () => {
              state.combos.currentIndex = index;
              highlightActiveComboTab();
              loadCurrentComboFile();
            });
            group.appendChild(tab);
          });

          tabBar.appendChild(group);
        });

        highlightActiveComboTab();
      }

      function highlightActiveComboTab() {
        document.querySelectorAll(".combo-tab").forEach((tab) => {
          const index = parseInt(tab.dataset.index, 10);
          tab.classList.toggle("active", index === state.combos.currentIndex);
        });
      }

      function loadCurrentComboFile() {
        const file = getCurrentComboFile();
        if (!file) {
          state.combos.editor.setValue("{}");
          document.getElementById("comboStatus").textContent =
            "Nessun file combo disponibile.";
          return;
        }

        const typeLabel = comboTypeLabels[file.type] || file.type || "";

        try {
          const formatted = formatJsonValue(file.content || "{}", {
            silent: true,
          });
          state.combos.editor.setValue(formatted);
          document.getElementById("comboStatus").textContent =
            typeLabel && typeLabel.length
              ? `${file.label || file.name} (${typeLabel}) caricato.`
              : `${file.label || file.name} caricato.`;
        } catch (error) {
          console.error(error);
          state.combos.editor.setValue(file.content || "{}");
          document.getElementById("comboStatus").textContent =
            typeLabel && typeLabel.length
              ? `${file.label || file.name} (${typeLabel}) caricato senza formattazione.`
              : `${file.label || file.name} caricato senza formattazione.`;
        }
        setTimeout(() => state.combos.editor.focus(), 100);
      }

      async function loadComboFiles(preserveSelection = true) {
        const statusEl = document.getElementById("comboStatus");
        const previousFile = preserveSelection ? getCurrentComboFile() : null;
        statusEl.textContent = "Caricamento file combo...";

        try {
          console.log("📂 Fetching combo files from /combo_files.json...");
          const response = await fetch("/combo_files.json", {
            cache: "no-cache",
          });
          if (!response.ok) throw new Error("Errore nel recupero dei file combo");
          const rawText = await response.text();
          console.log("📂 Response size:", rawText.length, "bytes");
          console.log("📂 First 200 chars:", rawText.substring(0, 200));
          const data = JSON.parse(rawText);
          console.log("📂 Received data:", data);
          console.log("📂 data.files type:", typeof data.files, "isArray:", Array.isArray(data.files));
          const files = Array.isArray(data.files) ? data.files : [];
          console.log("📂 Parsed files array:", files);

          state.combos.files = files
            .map((file) => ({
              name: file.name,
              label: file.label || prettifyComboFileLabel(file.name, file.type),
              type: file.type || "custom",
              content: file.content || "{}",
            }))
            .sort((a, b) => {
              const orderA = comboTypeOrder.hasOwnProperty(a.type)
                ? comboTypeOrder[a.type]
                : comboTypeOrder.unknown;
              const orderB = comboTypeOrder.hasOwnProperty(b.type)
                ? comboTypeOrder[b.type]
                : comboTypeOrder.unknown;
              if (orderA !== orderB) {
                return orderA - orderB;
              }
              return a.name.localeCompare(b.name);
            });

          if (state.combos.files.length === 0) {
            console.warn("⚠️ No combo files found!");
            state.combos.currentIndex = 0;
            updateComboTabs();
            loadCurrentComboFile();
            statusEl.textContent = "Nessun file combo trovato.";
            return;
          }

          console.log("📂 Total files after mapping:", state.combos.files.length);
          const preservedIndex = previousFile
            ? state.combos.files.findIndex((file) => file.name === previousFile.name)
            : -1;
          state.combos.currentIndex =
            preservedIndex >= 0 ? preservedIndex : 0;

          console.log("📂 Updating combo tabs...");
          updateComboTabs();
          console.log("📂 Loading current combo file...");
          loadCurrentComboFile();
          statusEl.textContent = "File combo caricati.";
          console.log("✅ Combo files loaded successfully");
        } catch (error) {
          console.error("❌ Error loading combo files:", error);
          statusEl.textContent = "Errore nel caricamento dei file combo.";
          showToast("Errore nel caricamento dei file combo.", "error");
        }
      }

      async function saveCurrentComboFile() {
        const file = getCurrentComboFile();
        if (!file) {
          showToast("Nessun file selezionato.", "error");
          return;
        }

        let parsed;
        try {
          parsed = JSON.parse(state.combos.editor.getValue());
        } catch (error) {
          showToast("JSON non valido. Correggi gli errori.", "error");
          return;
        }

        const prettyContent = JSON.stringify(parsed, null, 2);

        document.getElementById("comboStatus").textContent =
          `Salvataggio di ${file.name} in corso...`;
        let saveSuccessful = false;

        try {
          const fetchPromise = fetch("/combo_files.json", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: file.name,
              content: prettyContent,
            }),
          });
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error("timeout")), 5000)
          );
          const response = await Promise.race([fetchPromise, timeoutPromise]);
          const message = response ? await response.text() : "";
          document.getElementById("comboStatus").textContent =
            message || `File ${file.name} salvato.`;
          showToast(`File ${file.name} salvato.`, "success");
          saveSuccessful = true;
        } catch (error) {
          if (error.message === "timeout") {
            document.getElementById("comboStatus").textContent =
              `File ${file.name} salvato (timeout).`;
            showToast(
              "Salvataggio completato. Il dispositivo potrebbe essersi riavviato.",
              "success"
            );
            saveSuccessful = true;
          } else {
            console.error(error);
            document.getElementById("comboStatus").textContent =
              `Errore nel salvataggio di ${file.name}.`;
            showToast("Errore nel salvataggio del file.", "error");
          }
        }

        if (saveSuccessful) {
          file.content = prettyContent;
          if (state.combos.eventSource) {
            state.combos.eventSource.close();
          }
          setTimeout(setupComboLogs, 3000);
        }
      }

      function formatComboEditor() {
        const currentValue = state.combos.editor.getValue();
        try {
          const formatted = formatJsonValue(currentValue);
          state.combos.editor.setValue(formatted);
          showToast(
            hasPrettier
              ? "JSON formattato con Prettier."
              : "JSON formattato in modo basilare.",
            hasPrettier ? "info" : "success"
          );
        } catch (error) {
          console.error(error);
          showToast("Impossibile formattare il JSON.", "error");
        }
      }

      function setupComboLogs() {
        const logContainer = document.getElementById("comboLogContainer");
        logContainer.innerHTML = "";
        state.combos.eventSource = new EventSource("/log");

        state.combos.eventSource.onopen = () => {
          const entry = document.createElement("div");
          entry.textContent = "Connessione ai log stabilita.";
          entry.style.color = "#8f8";
          logContainer.appendChild(entry);
          logContainer.scrollTop = logContainer.scrollHeight;
        };

        state.combos.eventSource.onmessage = (event) => {
          const entry = document.createElement("div");
          entry.textContent = event.data;
          logContainer.appendChild(entry);
          logContainer.scrollTop = logContainer.scrollHeight;
        };

        state.combos.eventSource.onerror = () => {
          const entry = document.createElement("div");
          entry.textContent =
            "Connessione ai log interrotta. Premi Riconnetti per riprovare.";
          entry.style.color = "#f88";
          logContainer.appendChild(entry);
          logContainer.scrollTop = logContainer.scrollHeight;
          state.combos.eventSource.close();
        };
      }

      function initializeEventHandlers() {
        document
          .getElementById("wifiForm")
          .addEventListener("submit", async (event) => {
            event.preventDefault();
            const wifi = gatherWifiDataFromForm();
            await submitWifiConfig({ wifi }, document.getElementById("wifiFormStatus"));
            state.wifi.lastUpdated = new Date();
            updateWifiUpdatedLabel();
            updateWifiModeLabel(wifi);
            showToast("Configurazione inviata. Il dispositivo potrebbe riavviarsi.", "success");
          });

        document
          .getElementById("resetWifiForm")
          .addEventListener("click", resetWifiForm);

        document
          .getElementById("refreshWifiData")
          .addEventListener("click", async () => {
            await Promise.all([
              refreshDeviceStatus(true),
              loadWifiConfig(true),
            ]);
          });

        document
          .getElementById("fillWizardFromForm")
          .addEventListener("click", sendFormValuesToWizard);

        const openDataExplorerBtn = document.getElementById("openDataExplorer");
        if (openDataExplorerBtn) {
          openDataExplorerBtn.addEventListener("click", () =>
            activateTab("panel-data")
          );
        }

        const refreshAllBtn = document.getElementById("refreshAllData");
        if (refreshAllBtn) {
          refreshAllBtn.addEventListener("click", async () => {
            await Promise.all([loadWifiConfig(true), loadIrData(true)]);
          });
        }

        const refreshConfigBtn = document.getElementById("refreshConfigData");
        if (refreshConfigBtn) {
          refreshConfigBtn.addEventListener("click", () => loadWifiConfig(true));
        }

        const refreshIrBtn = document.getElementById("refreshIrData");
        if (refreshIrBtn) {
          refreshIrBtn.addEventListener("click", () => loadIrData(true));
        }

        const copyConfigBtn = document.getElementById("copyConfigJson");
        if (copyConfigBtn) {
          copyConfigBtn.addEventListener("click", () =>
            copyToClipboard(state.data.rawConfig, "config.json copiato.")
          );
        }

        const copyIrBtn = document.getElementById("copyIrJson");
        if (copyIrBtn) {
          copyIrBtn.addEventListener("click", () =>
            copyToClipboard(state.data.rawIr, "ir_data.json copiato.")
          );
        }

        const downloadConfigBtn = document.getElementById("downloadConfigJson");
        if (downloadConfigBtn) {
          downloadConfigBtn.addEventListener("click", () =>
            downloadJson("config.json", state.data.rawConfig || "{}")
          );
        }

        const downloadIrBtn = document.getElementById("downloadIrJson");
        if (downloadIrBtn) {
          downloadIrBtn.addEventListener("click", () =>
            downloadJson("ir_data.json", state.data.rawIr || "{}")
          );
        }
      }

      async function init() {
        setupTabs();
        setupWizard();
        initializeEventHandlers();
        setupComboEditor();
        renderConfigDataExplorer();
        renderIrDataExplorer();
        updateDataMetaLabels();
        updateRawJsonBlocks();
        await refreshDeviceStatus();
        await loadWifiConfig();
        await loadIrData();
        await loadComboFiles();
        setupComboLogs();
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
