<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MacroPad · Pianificatore</title>
    <link
      rel="icon"
      href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9IiMwZTYzOWMiLz48dGV4dCB4PSI1MCUiIHk9IjU1JSIgZm9udC1zaXplPSIzMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI2ZmZmZmZiIgZm9udC1mYW1pbHk9IlNlZ29lIFVJLCBBcmlhbCwgc2Fucy1zZXJpZiI+TTwvdGV4dD48L3N2Zz4="
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/ui/app.css" />
    <style>
      .panel-heading {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }
      .panel-heading .card-title {
        margin: 0;
      }
      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
      }
      .status-chip {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
      .status-chip strong {
        font-size: 1.1rem;
        color: #fff;
      }
      .status-chip small {
        color: var(--text-secondary);
      }
      .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
      }
      .event-card h3 {
        margin: 0;
        font-size: 1.05rem;
      }
      .event-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.78rem;
        border: 1px solid transparent;
      }
      .badge.success {
        background: rgba(14, 122, 58, 0.15);
        color: #4fe49c;
        border-color: rgba(14, 122, 58, 0.4);
      }
      .badge.error {
        background: rgba(161, 38, 13, 0.15);
        color: #ff9070;
        border-color: rgba(161, 38, 13, 0.4);
      }
      .badge.info {
        background: rgba(14, 99, 156, 0.15);
        color: #7bc6ff;
        border-color: rgba(14, 99, 156, 0.4);
      }
      .badge.warning {
        background: rgba(213, 153, 24, 0.15);
        color: #ffd37e;
        border-color: rgba(213, 153, 24, 0.4);
      }
      .muted {
        color: var(--text-secondary);
        font-size: 0.9rem;
      }
      .logs-box {
        border: 1px dashed var(--border-color);
        border-radius: 6px;
        padding: 10px;
        font-family: "JetBrains Mono", "Fira Code", monospace;
        background: rgba(255, 255, 255, 0.02);
        max-height: 115px;
        overflow-y: auto;
        font-size: 0.85rem;
      }
      .actions-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .toast {
        position: fixed;
        right: 16px;
        bottom: 16px;
        min-width: 220px;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-secondary);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
        display: flex;
        gap: 10px;
        align-items: center;
        animation: slideIn 0.2s ease;
      }
      .toast.success {
        border-color: rgba(14, 122, 58, 0.5);
      }
      .toast.error {
        border-color: rgba(161, 38, 13, 0.5);
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .loading-state {
        padding: 40px;
        text-align: center;
        color: var(--text-secondary);
      }
      .chip-set {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .chip {
        border-radius: 999px;
        border: 1px solid var(--border-color);
        padding: 4px 10px;
        font-size: 0.78rem;
        background: rgba(255, 255, 255, 0.03);
      }
      @media (max-width: 720px) {
        .panel-heading {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <header class="app-header">
        <div class="branding">
          <i class="fas fa-calendar-check"></i>
          <span>Pianificatore MacroPad</span>
        </div>
        <div class="actions-bar">
          <a class="secondary-btn" href="/config.html">
            <i class="fas fa-sliders-h"></i> Configurazione
          </a>
          <a class="secondary-btn" href="/special_actions.html">
            <i class="fas fa-bolt"></i> Azioni rapide
          </a>
          <button id="refreshBtn" class="primary-btn">
            <i class="fas fa-sync-alt"></i> Aggiorna stato
          </button>
        </div>
      </header>

      <section class="panel active">
        <div class="panel-heading">
          <div>
            <h2 class="card-title">
              <i class="fas fa-gauge"></i> Stato del pianificatore
            </h2>
            <p class="muted" id="lastUpdated">Ultimo aggiornamento: --</p>
          </div>
        </div>
        <div class="status-grid" id="statusGrid">
          <div class="card status-card">
            <div class="status-chip">
              <small>Scheduler</small>
              <strong id="schedulerEnabled">--</strong>
            </div>
          </div>
          <div class="card status-card">
            <div class="status-chip">
              <small>Clock</small>
              <strong id="clockStatus">--</strong>
            </div>
          </div>
          <div class="card status-card">
            <div class="status-chip">
              <small>Timezone</small>
              <strong id="timezoneInfo">--</strong>
            </div>
          </div>
          <div class="card status-card">
            <div class="status-chip">
              <small>Protezione Sleep</small>
              <strong id="sleepGuard">--</strong>
            </div>
          </div>
        </div>
      </section>

      <section class="panel active">
        <div class="panel-heading">
          <div>
            <h2 class="card-title">
              <i class="fas fa-clock"></i> Allineamento orario
            </h2>
            <p class="muted">
              Imposta manualmente l'orologio dell'ESP32 quando non è disponibile
              la sincronizzazione automatica.
            </p>
          </div>
        </div>
        <article class="card">
          <form id="timeForm" class="form-grid">
            <div class="status-grid">
              <div class="form-group">
                <label for="datetimeInput"
                  >Data/ora (locale dispositivo) · `datetime-local`</label
                >
                <input type="datetime-local" id="datetimeInput" required />
              </div>
              <div class="form-group">
                <label for="timezoneInput"
                  >Timezone offset (minuti, es. +60 CET)</label
                >
                <input
                  type="number"
                  id="timezoneInput"
                  step="15"
                  placeholder="0"
                />
              </div>
            </div>
            <div class="actions-bar">
              <button type="button" class="secondary-btn" id="fillNowBtn">
                <i class="fas fa-clock-rotate-left"></i> Usa ora corrente
              </button>
              <button type="submit" class="primary-btn">
                <i class="fas fa-save"></i> Aggiorna orologio
              </button>
            </div>
          </form>
        </article>
      </section>

      <section class="panel active">
        <div class="panel-heading">
          <div>
            <h2 class="card-title">
              <i class="fas fa-list-check"></i> Eventi programmati
            </h2>
            <p class="muted">
              Ogni evento può richiamare una special action, posticipare lo
              sleep o riattivare il dispositivo in base al trigger.
            </p>
          </div>
          <div class="chip-set" id="summaryChips"></div>
        </div>
        <div id="eventsContainer" class="events-grid">
          <div class="loading-state">
            <i class="fas fa-spinner fa-spin"></i> Caricamento pianificatore...
          </div>
        </div>
      </section>
    </div>

    <script>
      const stateLabels = {
        0: "N/D",
        1: "Orario",
        2: "Intervallo",
        3: "Assoluto",
        4: "Input"
      };

      const schedulerEnabledEl = document.getElementById("schedulerEnabled");
      const clockStatusEl = document.getElementById("clockStatus");
      const timezoneInfoEl = document.getElementById("timezoneInfo");
      const sleepGuardEl = document.getElementById("sleepGuard");
      const lastUpdatedEl = document.getElementById("lastUpdated");
      const eventsContainer = document.getElementById("eventsContainer");
      const summaryChips = document.getElementById("summaryChips");
      const refreshBtn = document.getElementById("refreshBtn");
      const timeForm = document.getElementById("timeForm");
      const timezoneInput = document.getElementById("timezoneInput");
      const datetimeInput = document.getElementById("datetimeInput");
      const fillNowBtn = document.getElementById("fillNowBtn");

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fas fa-info-circle"></i><span>${message}</span>`;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 4000);
      }

      function formatDate(epochSeconds) {
        if (!epochSeconds || epochSeconds <= 0) return "--";
        const date = new Date(epochSeconds * 1000);
        return date.toLocaleString();
      }

      function formatDelta(seconds) {
        if (seconds === undefined || seconds === null) return "--";
        const sec = Number(seconds);
        if (Number.isNaN(sec)) return "--";
        if (sec <= 0) return "imminente";
        if (sec < 60) return `${Math.round(sec)}s`;
        if (sec < 3600) return `${Math.round(sec / 60)} min`;
        if (sec < 86400) return `${(sec / 3600).toFixed(1)} h`;
        return `${(sec / 86400).toFixed(1)} giorni`;
      }

      function formatMs(ms) {
        if (!ms) return "--";
        const seconds = ms / 1000;
        return formatDelta(seconds);
      }

      function updateStatusHeader(data) {
        schedulerEnabledEl.textContent = data.enabled ? "Attivo" : "Disattivo";
        schedulerEnabledEl.style.color = data.enabled ? "#4fe49c" : "#ff9070";

        clockStatusEl.textContent = data.time_valid
          ? "Valido"
          : "Non sincronizzato";
        clockStatusEl.style.color = data.time_valid ? "#4fe49c" : "#ff9070";

        const tz = data.timezone_minutes || 0;
        timezoneInfoEl.textContent = tz >= 0 ? `UTC+${tz / 60}` : `UTC${tz / 60}`;
        sleepGuardEl.textContent = `${data.sleep_guard_seconds || 0}s`;

        const now = new Date();
        lastUpdatedEl.textContent = `Ultimo aggiornamento: ${now.toLocaleString()}`;
      }

      function buildSummary(events = []) {
        if (!events.length) {
          summaryChips.innerHTML =
            '<span class="chip">Nessun evento configurato</span>';
          return;
        }
        const enabled = events.filter((e) => e.enabled).length;
        const wakeable = events.filter((e) => e.wake_from_sleep).length;
        const prevent = events.filter((e) => e.prevent_sleep).length;
        summaryChips.innerHTML = "";
        summaryChips.insertAdjacentHTML(
          "beforeend",
          `<span class="chip"><i class="fas fa-toggle-on"></i> Abilitati: ${enabled}/${events.length}</span>`
        );
        summaryChips.insertAdjacentHTML(
          "beforeend",
          `<span class="chip"><i class="fas fa-bed"></i> Wake: ${wakeable}</span>`
        );
        summaryChips.insertAdjacentHTML(
          "beforeend",
          `<span class="chip"><i class="fas fa-shield-halved"></i> Sleep guard: ${prevent}</span>`
        );
      }

      function renderEvents(events = []) {
        if (!events.length) {
          eventsContainer.innerHTML =
            '<div class="loading-state muted">Nessun evento definito in config.json</div>';
          return;
        }

        eventsContainer.innerHTML = "";
        events.forEach((evt) => {
          const card = document.createElement("article");
          card.className = "card event-card";

          const triggerLabel = stateLabels[evt.trigger] || "Custom";
          const badges = [];
          if (evt.enabled) badges.push('<span class="badge success">ENABLED</span>');
          else badges.push('<span class="badge error">DISABLED</span>');
          if (evt.pending)
            badges.push('<span class="badge warning">PENDING</span>');
          if (evt.prevent_sleep)
            badges.push('<span class="badge info">Sleep guard</span>');
          if (evt.wake_from_sleep)
            badges.push('<span class="badge info">Wake timer</span>');

          const lastRun = evt.last_run_epoch
            ? `${formatDate(evt.last_run_epoch)}`
            : "--";

          const nextInfo =
            evt.next_epoch && evt.next_epoch > 0
              ? `${formatDate(evt.next_epoch)} (${formatDelta(evt.seconds_to_next)})`
              : evt.ms_to_next
              ? `In ${formatMs(evt.ms_to_next)}`
              : "N/D";

          card.innerHTML = `
            <div class="event-meta">
              ${badges.join(" ")}
            </div>
            <h3>${evt.id}</h3>
            <p class="muted">${evt.description || "Nessuna descrizione"}</p>
            <div class="chip-set">
              <span class="chip"><i class="fas fa-bell"></i> Trigger: ${triggerLabel}</span>
              <span class="chip"><i class="fas fa-hourglass-half"></i> Next: ${nextInfo}</span>
            </div>
            <div class="chip-set">
              <span class="chip"><i class="fas fa-clock"></i> Ultima esecuzione: ${lastRun}</span>
              <span class="chip"><i class="fas fa-repeat"></i> Esecuzioni: ${evt.executions || 0}</span>
            </div>
            <div>
              <label class="muted">Ultimo messaggio</label>
              <div class="logs-box">${evt.last_message || "Nessun log"}</div>
            </div>
            <div class="actions-bar">
              <button class="secondary-btn run-btn" data-id="${evt.id}" ${evt.enabled ? "" : "disabled"}>
                <i class="fas fa-play"></i> Esegui adesso
              </button>
            </div>
          `;
          eventsContainer.appendChild(card);
        });

        eventsContainer
          .querySelectorAll(".run-btn")
          .forEach((btn) =>
            btn.addEventListener("click", () => runEvent(btn.dataset.id, btn))
          );
      }

      async function runEvent(id, buttonEl) {
        if (!id) return;
        buttonEl.disabled = true;
        buttonEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> In esecuzione';
        try {
          const res = await fetch("/scheduler/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, reason: "webui" })
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok) {
            showToast(`Evento ${id} eseguito`, "success");
            await loadState();
          } else {
            showToast(
              data.error || `Esecuzione ${id} fallita (${res.status})`,
              "error"
            );
          }
        } catch (err) {
          showToast("Errore rete: " + err.message, "error");
        } finally {
          buttonEl.disabled = false;
          buttonEl.innerHTML = '<i class="fas fa-play"></i> Esegui adesso';
        }
      }

      async function submitTime(event) {
        event.preventDefault();
        const value = datetimeInput.value;
        if (!value) {
          showToast("Inserisci data e ora valide", "error");
          return;
        }
        const epoch = Math.floor(new Date(value).getTime() / 1000);
        if (!epoch || Number.isNaN(epoch)) {
          showToast("Formato data non valido", "error");
          return;
        }
        const tz = parseInt(timezoneInput.value || "0", 10);

        try {
          const res = await fetch("/scheduler/time", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ epoch, timezone_minutes: tz })
          });
          if (res.ok) {
            showToast("Orologio aggiornato", "success");
            await loadState();
          } else {
            const data = await res.json().catch(() => ({}));
            showToast(
              data.error || `Errore aggiornamento orario (${res.status})`,
              "error"
            );
          }
        } catch (err) {
          showToast("Errore rete: " + err.message, "error");
        }
      }

      async function loadState() {
        eventsContainer.innerHTML =
          '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Aggiornamento...</div>';
        try {
          const res = await fetch("/scheduler/state");
          if (!res.ok) throw new Error(res.statusText);
          const data = await res.json();
          updateStatusHeader(data);
          buildSummary(data.events);
          renderEvents(data.events);
        } catch (err) {
          eventsContainer.innerHTML =
            '<div class="loading-state">Impossibile recuperare lo stato</div>';
          showToast("Errore caricamento: " + err.message, "error");
        }
      }

      function fillNow() {
        const now = new Date();
        const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);
        datetimeInput.value = local;
        timezoneInput.value = -now.getTimezoneOffset();
      }

      refreshBtn.addEventListener("click", loadState);
      timeForm.addEventListener("submit", submitTime);
      fillNowBtn.addEventListener("click", fillNow);

      fillNow();
      loadState();
    </script>
  </body>
</html>
